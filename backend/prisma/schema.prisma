// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("staff") // admin, doctor, staff
  language  String   @default("tr")    // tr, en, ar
  createdAt DateTime @default(now())
  
  branchId  String?
  branch    Branch?  @relation(fields: [branchId], references: [id])
  
  appointments Appointment[]
  messages     Message[]
  notifications Notification[]
  tickets      SupportTicket[]
  performances StaffPerformance[]
  
  twoFactorEnabled Boolean @default(false)
  twoFactorCode    String?
  twoFactorExpires DateTime?
}

model Branch {
  id        String   @id @default(uuid())
  name      String
  address   String?
  city      String
  createdAt DateTime @default(now())
  
  users     User[]
  patients  Patient[]
  
  clinicId  String?
  clinic    Clinic? @relation(fields: [clinicId], references: [id])
}

model Clinic {
  id        String   @id @default(uuid())
  name      String
  contactInfo String?
  createdAt DateTime @default(now())
  
  branches  Branch[]
}

model Patient {
  id          String   @id @default(uuid())
  fullName    String
  email       String?
  phoneNumber String?
  language    String   @default("tr")
  status      String   @default("active") // active, lead, treated
  source      String   @default("Web")    // Web, Instagram, WhatsApp, Referral
  notes       String?
  tags        String?  // CSV: VIP, Risk, etc.
  createdAt   DateTime @default(now())
  
  branchId  String?
  branch    Branch?  @relation(fields: [branchId], references: [id])
  
  appointments   Appointment[]
  transfers      Transfer[]
  accommodations Accommodation[]
  invoices       Invoice[]
  photos         PhotoEntry[]
  calls          CallLog[]
  surveys        SurveyResult[]
}

model Appointment {
  id        String   @id @default(uuid())
  date      DateTime
  type      String
  graftCount Int?     // For Hair Transplant analytics
  status    String   @default("scheduled") // scheduled, completed, cancelled
  
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])
  
  doctorId  String
  doctor    User    @relation(fields: [doctorId], references: [id])
  
  createdAt DateTime @default(now())
}

model Conversation {
  id        String   @id @default(uuid())
  platform  String   // whatsapp, instagram, sms, internal
  contact   String   // Phone or Username
  updatedAt DateTime @updatedAt
  
  channelId String?  // Optional external ID (e.g. WA ID)
  
  messages  Message[]
}

model Message {
  id             String   @id @default(uuid())
  content        String
  isFromUser     Boolean
  createdAt      DateTime @default(now())
  
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  
  userId         String?
  user           User?    @relation(fields: [userId], references: [id])
}

model BookingLink {
  id          String   @id @default(uuid())
  slug        String   @unique
  doctorId    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
}

model SupportTicket {
  id          String   @id @default(uuid())
  subject     String
  message     String
  status      String   @default("open") // open, resolved
  createdAt   DateTime @default(now())
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
}

// Health Tourism Modules

model Transfer {
  id          String   @id @default(uuid())
  pickupTime  DateTime
  pickupLocation String
  dropoffLocation String
  driverName  String?
  plateNumber String?
  status      String   @default("scheduled") // scheduled, completed, cancelled
  
  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id])
}

model Accommodation {
  id          String   @id @default(uuid())
  hotelName   String
  checkInDate DateTime
  checkOutDate DateTime
  roomType    String?
  status      String   @default("booked") // booked, checked-in, checked-out
  
  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id])
}

// Financial Modules

model Invoice {
  id          String   @id @default(uuid())
  amount      Float
  currency    String   @default("TRY")
  status      String   @default("pending") // pending, paid, cancelled
  type        String   @default("service") // service, product
  description String
  invoiceDate DateTime @default(now())
  
  // E-Invoice specifics
  eInvoiceNumber String? // GIB number e.g. GIB2024...
  
  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id])
  
  transactions Transaction[]
}

model Expense {
  id          String   @id @default(uuid())
  amount      Float
  category    String   // Rent, Supplies, Marketing
  description String
  date        DateTime @default(now())
  
  supplierId  String?
  supplier    Supplier? @relation(fields: [supplierId], references: [id])
}

model Product {
  id          String   @id @default(uuid())
  name        String
  stock       Int
  price       Float
  sku         String?
}

// Visual Records

model PhotoEntry {
  id          String   @id @default(uuid())
  beforeUrl   String?
  afterUrl    String?
  date        DateTime @default(now())
  notes       String?
  
  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id])
}

// Advanced Operations & Engagement

model CallLog {
  id          String   @id @default(uuid())
  callerNumber String
  direction   String   // inbound, outbound
  status      String   // missed, answered
  duration    Int      // seconds
  timestamp   DateTime @default(now())
  
  patientId   String?
  patient     Patient? @relation(fields: [patientId], references: [id])
}

model Notification {
  id          String   @id @default(uuid())
  title       String
  message     String
  type        String   // retention, birthday, appointment
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  userId      String?  // Targeted staff member
  user        User?    @relation(fields: [userId], references: [id])
}

model SurveyResult {
  id          String   @id @default(uuid())
  rating      Int
  feedback    String?
  createdAt   DateTime @default(now())
  
  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id])
}

// Marketing & Campaigns (Real Data Implementation)

model Campaign {
  id          String   @id @default(uuid())
  title       String
  message     String
  channel     String   // whatsapp, sms, email
  targetAudience String // all, leads, retention
  sentCount   Int      @default(0)
  status      String   @default("completed")
  createdAt   DateTime @default(now())
  
  logs        CampaignLog[]
  emailLogs   EmailLog[]
}

model CampaignLog {
  id          String   @id @default(uuid())
  status      String   // sent, delivered, failed
  recipient   String
  timestamp   DateTime @default(now())
  
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id])
}

// PRD Mandatory Models

model MessageLog {
  id        String   @id @default(uuid())
  type      String   // WhatsApp, SMS
  recipient String
  status    String   // sent, failed
  content   String?
  timestamp DateTime @default(now())
}

model AutomationLog {
  id           String   @id @default(uuid())
  workflowName String
  trigger      String
  status       String   // success, failed
  timestamp    DateTime @default(now())
  metadata     String?
}

// --- PHASE 5: COMMUNICATION & IYS ---

model EmailLog {
  id        String   @id @default(uuid())
  recipient String
  subject   String
  status    String   // sent, failed, delivered, opened
  error     String?
  sentAt    DateTime @default(now())

  campaignId String?
  campaign   Campaign? @relation(fields: [campaignId], references: [id])
}

model IYSLog {
  id          String   @id @default(uuid())
  recipient   String
  type        String   // EMAIL, CALL, SMS
  source      String   // HS_FIZIKSEL_ORTAM, HS_ISLAK_IMZA, etc.
  status      String   // active, passive
  consentDate DateTime @default(now())
  syncedAt    DateTime? 
}

model OptOut {
  id        String   @id @default(uuid())
  contact   String   @unique // Phone or Email
  channel   String   // SMS, EMAIL, ALL
  reason    String?
  createdAt DateTime @default(now())
}

// --- PHASE 6: HR & FINANCE ---

model CommissionRule {
  id        String   @id @default(uuid())
  role      String?  // e.g. "doctor"
  userId    String?  // Specific user override
  type      String   // "percentage", "fixed"
  value     Float    // e.g. 10.0 for 10%
  serviceType String? // e.g. "Hair Transplant", "Botox" - null for all
  createdAt DateTime @default(now())
}

model StaffPerformance {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  month     String   // YYYY-MM
  targetAmount Float
  actualAmount Float @default(0)
  commissionEarned Float @default(0)
}

model Supplier {
  id        String   @id @default(uuid())
  name      String
  taxNumber String?
  contact   String?
  balance   Float    @default(0)
  createdAt DateTime @default(now())
  
  expenses  Expense[]
}

model CurrentAccount {
  id        String   @id @default(uuid())
  name      String
  type      String   // "supplier", "patient", "personnel", "other"
  balance   Float    @default(0) // Positive = We owe them, Negative = They owe us? Or standard accounting credit/debit logic
  currency  String   @default("TRY")
  
  transactions Transaction[]
}

model Transaction {
  id        String   @id @default(uuid())
  accountId String
  account   CurrentAccount @relation(fields: [accountId], references: [id])
  amount    Float
  type      String   // "credit", "debit"
  description String
  date      DateTime @default(now())
  
  invoiceId String?
  invoice   Invoice? @relation(fields: [invoiceId], references: [id])
}

model EInvoiceProfile {
  id        String   @id @default(uuid())
  provider  String   // "bizimhesap", "parasut", "netgsm"
  apiKey    String
  apiSecret String
  isActive  Boolean  @default(true)
}

// --- PHASE 7: CALL CENTER (VoIP) ---

model CallWebhookLog {
  id        String   @id @default(uuid())
  provider  String   // "verimor", "bulutsantralim"
  caller    String
  callee    String
  direction String
  status    String
  duration  Int?
  recordingUrl String?
  timestamp DateTime @default(now())
  rawPayload String? // JSON string
}

// --- PHASE 8: FINAL GAPS ---

model Permission {
  id          String   @id @default(uuid())
  action      String   // e.g. "create_patient", "delete_user"
  description String?
  roles       RolePermission[]
}

model RolePermission {
  id           String     @id @default(uuid())
  role         String     // "admin", "doctor", "staff" - matches User.role
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id])

  @@unique([role, permissionId])
}
